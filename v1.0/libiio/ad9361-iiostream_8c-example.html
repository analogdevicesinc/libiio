<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libiio: ad9361-iiostream.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libiio
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Library for interfacing with IIO devices</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ad9361-iiostream_8c-example.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">ad9361-iiostream.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>This example libiio program is meant to exercise the features of IIO functionality on the AD9361 found on the AD-FMCOMMS2-EBZ, AD-FMCOMMS3-EBZ, and the ADRV9361-Z7035 RF SOM.</p>
<div class="fragment"><div class="line"><span class="comment">// SPDX-License-Identifier: GPL-2.0-or-later</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * libiio - AD9361 IIO streaming example</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2014 IABG mbH</span></div>
<div class="line"><span class="comment"> * Author: Michael Feilen &lt;feilen_at_iabg.de&gt;</span></div>
<div class="line"><span class="comment"> **/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;iiostream-common.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iio/iio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iio/iio-debug.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* helper macros */</span></div>
<div class="line"><span class="preprocessor">#define MHZ(x) ((long long)(x*1000000.0 + .5))</span></div>
<div class="line"><span class="preprocessor">#define GHZ(x) ((long long)(x*1000000000.0 + .5))</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define IIO_ENSURE(expr) { \</span></div>
<div class="line"><span class="preprocessor">    if (!(expr)) { \</span></div>
<div class="line"><span class="preprocessor">        (void) fprintf(stderr, &quot;assertion failed (%s:%d)\n&quot;</span>, __FILE__, __LINE__); \</div>
<div class="line">        (void) abort(); \</div>
<div class="line">    } \</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define BLOCK_SIZE (1024 * 1024)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* RX is input, TX is output */</span></div>
<div class="line"><span class="keyword">enum</span> iodev { RX, TX };</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* common RX and TX streaming params */</span></div>
<div class="line"><span class="keyword">struct </span>stream_cfg {</div>
<div class="line">    <span class="keywordtype">long</span> <span class="keywordtype">long</span> bw_hz; <span class="comment">// Analog banwidth in Hz</span></div>
<div class="line">    <span class="keywordtype">long</span> <span class="keywordtype">long</span> fs_hz; <span class="comment">// Baseband sample rate in Hz</span></div>
<div class="line">    <span class="keywordtype">long</span> <span class="keywordtype">long</span> lo_hz; <span class="comment">// Local oscillator frequency in Hz</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* rfport; <span class="comment">// Port name</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* static scratch mem for strings */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> tmpstr[64];</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* IIO structs required for streaming */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_context *ctx   = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_channel *rx0_i = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_channel *rx0_q = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_channel *tx0_i = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_channel *tx0_q = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_buffer  *rxbuf = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_buffer  *txbuf = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_stream  *rxstream = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_stream  *txstream = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_channels_mask *rxmask = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_channels_mask *txmask = NULL;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* cleanup and exit */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> shutdown(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;* Destroying streams\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (rxstream) {iio_stream_destroy(rxstream); }</div>
<div class="line">    <span class="keywordflow">if</span> (txstream) { iio_stream_destroy(txstream); }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Destroying buffers\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (rxbuf) { iio_buffer_destroy(rxbuf); }</div>
<div class="line">    <span class="keywordflow">if</span> (txbuf) { iio_buffer_destroy(txbuf); }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Destroying channel masks\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (rxmask) { iio_channels_mask_destroy(rxmask); }</div>
<div class="line">    <span class="keywordflow">if</span> (txmask) { iio_channels_mask_destroy(txmask); }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Destroying context\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (ctx) { iio_context_destroy(ctx); }</div>
<div class="line">    exit(0);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> handle_sig(<span class="keywordtype">int</span> sig)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;Waiting for process to finish... Got signal %d\n&quot;</span>, sig);</div>
<div class="line">    stop_stream();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* check return value of attr_write function */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> errchk(<span class="keywordtype">int</span> v, <span class="keyword">const</span> <span class="keywordtype">char</span>* what) {</div>
<div class="line">     <span class="keywordflow">if</span> (v &lt; 0) { fprintf(stderr, <span class="stringliteral">&quot;Error %d writing to channel \&quot;%s\&quot;\nvalue may not be supported.\n&quot;</span>, v, what); shutdown(); }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* write attribute: long long int */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> wr_ch_lli(<span class="keyword">struct</span> iio_channel *chn, <span class="keyword">const</span> <span class="keywordtype">char</span>* what, <span class="keywordtype">long</span> <span class="keywordtype">long</span> val)</div>
<div class="line">{</div>
<div class="line">    errchk(iio_channel_attr_write_longlong(chn, what, val), what);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* write attribute: string */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> wr_ch_str(<span class="keyword">struct</span> iio_channel *chn, <span class="keyword">const</span> <span class="keywordtype">char</span>* what, <span class="keyword">const</span> <span class="keywordtype">char</span>* str)</div>
<div class="line">{</div>
<div class="line">    errchk(iio_channel_attr_write_string(chn, what, str), what);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* helper function generating channel names */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span>* get_ch_name(<span class="keyword">const</span> <span class="keywordtype">char</span>* type, <span class="keywordtype">int</span> <span class="keywordtype">id</span>)</div>
<div class="line">{</div>
<div class="line">    snprintf(tmpstr, <span class="keyword">sizeof</span>(tmpstr), <span class="stringliteral">&quot;%s%d&quot;</span>, type, <span class="keywordtype">id</span>);</div>
<div class="line">    <span class="keywordflow">return</span> tmpstr;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* returns ad9361 phy device */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_device* get_ad9361_phy(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>iio_device *dev =  iio_context_find_device(ctx, <span class="stringliteral">&quot;ad9361-phy&quot;</span>);</div>
<div class="line">    IIO_ENSURE(dev &amp;&amp; <span class="stringliteral">&quot;No ad9361-phy found&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> dev;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* finds AD9361 streaming IIO devices */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> get_ad9361_stream_dev(<span class="keyword">enum</span> iodev d, <span class="keyword">struct</span> iio_device **dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span> (d) {</div>
<div class="line">    <span class="keywordflow">case</span> TX: *dev = iio_context_find_device(ctx, <span class="stringliteral">&quot;cf-ad9361-dds-core-lpc&quot;</span>); <span class="keywordflow">return</span> *dev != NULL;</div>
<div class="line">    <span class="keywordflow">case</span> RX: *dev = iio_context_find_device(ctx, <span class="stringliteral">&quot;cf-ad9361-lpc&quot;</span>);  <span class="keywordflow">return</span> *dev != NULL;</div>
<div class="line">    <span class="keywordflow">default</span>: IIO_ENSURE(0); <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* finds AD9361 streaming IIO channels */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> get_ad9361_stream_ch(<span class="keyword">enum</span> iodev d, <span class="keyword">struct</span> iio_device *dev, <span class="keywordtype">int</span> chid, <span class="keyword">struct</span> iio_channel **chn)</div>
<div class="line">{</div>
<div class="line">    *chn = iio_device_find_channel(dev, get_ch_name(<span class="stringliteral">&quot;voltage&quot;</span>, chid), d == TX);</div>
<div class="line">    <span class="keywordflow">if</span> (!*chn)</div>
<div class="line">        *chn = iio_device_find_channel(dev, get_ch_name(<span class="stringliteral">&quot;altvoltage&quot;</span>, chid), d == TX);</div>
<div class="line">    <span class="keywordflow">return</span> *chn != NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* finds AD9361 phy IIO configuration channel with id chid */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> get_phy_chan(<span class="keyword">enum</span> iodev d, <span class="keywordtype">int</span> chid, <span class="keyword">struct</span> iio_channel **chn)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span> (d) {</div>
<div class="line">    <span class="keywordflow">case</span> RX: *chn = iio_device_find_channel(get_ad9361_phy(), get_ch_name(<span class="stringliteral">&quot;voltage&quot;</span>, chid), <span class="keyword">false</span>); <span class="keywordflow">return</span> *chn != NULL;</div>
<div class="line">    <span class="keywordflow">case</span> TX: *chn = iio_device_find_channel(get_ad9361_phy(), get_ch_name(<span class="stringliteral">&quot;voltage&quot;</span>, chid), <span class="keyword">true</span>);  <span class="keywordflow">return</span> *chn != NULL;</div>
<div class="line">    <span class="keywordflow">default</span>: IIO_ENSURE(0); <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* finds AD9361 local oscillator IIO configuration channels */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> get_lo_chan(<span class="keyword">enum</span> iodev d, <span class="keyword">struct</span> iio_channel **chn)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span> (d) {</div>
<div class="line">     <span class="comment">// LO chan is always output, i.e. true</span></div>
<div class="line">    <span class="keywordflow">case</span> RX: *chn = iio_device_find_channel(get_ad9361_phy(), get_ch_name(<span class="stringliteral">&quot;altvoltage&quot;</span>, 0), <span class="keyword">true</span>); <span class="keywordflow">return</span> *chn != NULL;</div>
<div class="line">    <span class="keywordflow">case</span> TX: *chn = iio_device_find_channel(get_ad9361_phy(), get_ch_name(<span class="stringliteral">&quot;altvoltage&quot;</span>, 1), <span class="keyword">true</span>); <span class="keywordflow">return</span> *chn != NULL;</div>
<div class="line">    <span class="keywordflow">default</span>: IIO_ENSURE(0); <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* applies streaming configuration through IIO */</span></div>
<div class="line"><span class="keywordtype">bool</span> cfg_ad9361_streaming_ch(<span class="keyword">struct</span> stream_cfg *cfg, <span class="keyword">enum</span> iodev type, <span class="keywordtype">int</span> chid)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>iio_channel *chn = NULL;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Configure phy and lo channels</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;* Acquiring AD9361 phy channel %d\n&quot;</span>, chid);</div>
<div class="line">    <span class="keywordflow">if</span> (!get_phy_chan(type, chid, &amp;chn)) {  <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">    <span class="keywordtype">int</span> ret = iio_channel_attr_write_string(chn, <span class="stringliteral">&quot;rf_port_select&quot;</span>, cfg-&gt;rfport);</div>
<div class="line">    <span class="keywordflow">if</span> (ret == -EINVAL)</div>
<div class="line">        printf(<span class="stringliteral">&quot;Error writing %s to channel \&quot;rf_port_select\&quot;\nThis error can be ignored for PlutoSDR and derivatives.\n&quot;</span>,</div>
<div class="line">                        cfg-&gt;rfport);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        errchk(ret, <span class="stringliteral">&quot;rf_port_select&quot;</span>);</div>
<div class="line">    wr_ch_lli(chn, <span class="stringliteral">&quot;rf_bandwidth&quot;</span>,       cfg-&gt;bw_hz);</div>
<div class="line">    wr_ch_lli(chn, <span class="stringliteral">&quot;sampling_frequency&quot;</span>, cfg-&gt;fs_hz);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Configure LO channel</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;* Acquiring AD9361 %s lo channel\n&quot;</span>, type == TX ? <span class="stringliteral">&quot;TX&quot;</span> : <span class="stringliteral">&quot;RX&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (!get_lo_chan(type, &amp;chn)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">    wr_ch_lli(chn, <span class="stringliteral">&quot;frequency&quot;</span>, cfg-&gt;lo_hz);</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* simple configuration and streaming */</span></div>
<div class="line"><span class="comment">/* usage:</span></div>
<div class="line"><span class="comment"> * Default context, assuming local IIO devices, i.e., this script is run on ADALM-Pluto for example</span></div>
<div class="line"><span class="comment"> $./a.out</span></div>
<div class="line"><span class="comment"> * URI context, find out the uri by typing `iio_info -s` at the command line of the host PC</span></div>
<div class="line"><span class="comment"> $./a.out usb:x.x.x</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Streaming devices</span></div>
<div class="line">    <span class="keyword">struct </span>iio_device *tx;</div>
<div class="line">    <span class="keyword">struct </span>iio_device *rx;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// RX and TX sample counters</span></div>
<div class="line">    <span class="keywordtype">size_t</span> nrx = 0;</div>
<div class="line">    <span class="keywordtype">size_t</span> ntx = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// RX and TX sample size</span></div>
<div class="line">    <span class="keywordtype">size_t</span> rx_sample_sz, tx_sample_sz;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Stream configurations</span></div>
<div class="line">    <span class="keyword">struct </span>stream_cfg rxcfg;</div>
<div class="line">    <span class="keyword">struct </span>stream_cfg txcfg;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> err;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Listen to ctrl+c and IIO_ENSURE</span></div>
<div class="line">    signal(SIGINT, handle_sig);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// RX stream config</span></div>
<div class="line">    rxcfg.bw_hz = MHZ(2);   <span class="comment">// 2 MHz rf bandwidth</span></div>
<div class="line">    rxcfg.fs_hz = MHZ(2.5);   <span class="comment">// 2.5 MS/s rx sample rate</span></div>
<div class="line">    rxcfg.lo_hz = GHZ(2.5); <span class="comment">// 2.5 GHz rf frequency</span></div>
<div class="line">    rxcfg.rfport = <span class="stringliteral">&quot;A_BALANCED&quot;</span>; <span class="comment">// port A (select for rf freq.)</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// TX stream config</span></div>
<div class="line">    txcfg.bw_hz = MHZ(1.5); <span class="comment">// 1.5 MHz rf bandwidth</span></div>
<div class="line">    txcfg.fs_hz = MHZ(2.5);   <span class="comment">// 2.5 MS/s tx sample rate</span></div>
<div class="line">    txcfg.lo_hz = GHZ(2.5); <span class="comment">// 2.5 GHz rf frequency</span></div>
<div class="line">    txcfg.rfport = <span class="stringliteral">&quot;A&quot;</span>; <span class="comment">// port A (select for rf freq.)</span></div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Acquiring IIO context\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (argc == 1) {</div>
<div class="line">        IIO_ENSURE((ctx = iio_create_context(NULL, NULL)) &amp;&amp; <span class="stringliteral">&quot;No context&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argc == 2) {</div>
<div class="line">        IIO_ENSURE((ctx = iio_create_context(NULL, argv[1])) &amp;&amp; <span class="stringliteral">&quot;No context&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    IIO_ENSURE(iio_context_get_devices_count(ctx) &gt; 0 &amp;&amp; <span class="stringliteral">&quot;No devices&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Acquiring AD9361 streaming devices\n&quot;</span>);</div>
<div class="line">    IIO_ENSURE(get_ad9361_stream_dev(TX, &amp;tx) &amp;&amp; <span class="stringliteral">&quot;No tx dev found&quot;</span>);</div>
<div class="line">    IIO_ENSURE(get_ad9361_stream_dev(RX, &amp;rx) &amp;&amp; <span class="stringliteral">&quot;No rx dev found&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Configuring AD9361 for streaming\n&quot;</span>);</div>
<div class="line">    IIO_ENSURE(cfg_ad9361_streaming_ch(&amp;rxcfg, RX, 0) &amp;&amp; <span class="stringliteral">&quot;RX port 0 not found&quot;</span>);</div>
<div class="line">    IIO_ENSURE(cfg_ad9361_streaming_ch(&amp;txcfg, TX, 0) &amp;&amp; <span class="stringliteral">&quot;TX port 0 not found&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Initializing AD9361 IIO streaming channels\n&quot;</span>);</div>
<div class="line">    IIO_ENSURE(get_ad9361_stream_ch(RX, rx, 0, &amp;rx0_i) &amp;&amp; <span class="stringliteral">&quot;RX chan i not found&quot;</span>);</div>
<div class="line">    IIO_ENSURE(get_ad9361_stream_ch(RX, rx, 1, &amp;rx0_q) &amp;&amp; <span class="stringliteral">&quot;RX chan q not found&quot;</span>);</div>
<div class="line">    IIO_ENSURE(get_ad9361_stream_ch(TX, tx, 0, &amp;tx0_i) &amp;&amp; <span class="stringliteral">&quot;TX chan i not found&quot;</span>);</div>
<div class="line">    IIO_ENSURE(get_ad9361_stream_ch(TX, tx, 1, &amp;tx0_q) &amp;&amp; <span class="stringliteral">&quot;TX chan q not found&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    rxmask = iio_create_channels_mask(iio_device_get_channels_count(rx));</div>
<div class="line">    <span class="keywordflow">if</span> (!rxmask) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Unable to alloc channels mask\n&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    txmask = iio_create_channels_mask(iio_device_get_channels_count(tx));</div>
<div class="line">    <span class="keywordflow">if</span> (!txmask) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Unable to alloc channels mask\n&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Enabling IIO streaming channels\n&quot;</span>);</div>
<div class="line">    iio_channel_enable(rx0_i, rxmask);</div>
<div class="line">    iio_channel_enable(rx0_q, rxmask);</div>
<div class="line">    iio_channel_enable(tx0_i, txmask);</div>
<div class="line">    iio_channel_enable(tx0_q, txmask);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Creating non-cyclic IIO buffers with 1 MiS\n&quot;</span>);</div>
<div class="line">    rxbuf = iio_device_create_buffer(rx, 0, rxmask);</div>
<div class="line">    err = iio_err(rxbuf);</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        rxbuf = NULL;</div>
<div class="line">        dev_perror(rx, err, <span class="stringliteral">&quot;Could not create RX buffer&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line">    txbuf = iio_device_create_buffer(tx, 0, txmask);</div>
<div class="line">    err = iio_err(txbuf);</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        txbuf = NULL;</div>
<div class="line">        dev_perror(tx, err, <span class="stringliteral">&quot;Could not create TX buffer&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    rxstream = iio_buffer_create_stream(rxbuf, 4, BLOCK_SIZE);</div>
<div class="line">    err = iio_err(rxstream);</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        rxstream = NULL;</div>
<div class="line">        dev_perror(rx, iio_err(rxstream), <span class="stringliteral">&quot;Could not create RX stream&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    txstream = iio_buffer_create_stream(txbuf, 4, BLOCK_SIZE);</div>
<div class="line">    err = iio_err(txstream);</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        txstream = NULL;</div>
<div class="line">        dev_perror(tx, iio_err(txstream), <span class="stringliteral">&quot;Could not create TX stream&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    tx_sample_sz = iio_device_get_sample_size(tx, rxmask);</div>
<div class="line">    rx_sample_sz = iio_device_get_sample_size(rx, txmask);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Starting IO streaming (press CTRL+C to cancel)\n&quot;</span>);</div>
<div class="line">    stream(rx_sample_sz, tx_sample_sz, BLOCK_SIZE,</div>
<div class="line">           rxstream, txstream, rx0_i, tx0_i);</div>
<div class="line"> </div>
<div class="line">    shutdown();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
    Copyright <a href="https://github.com/analogdevicesinc/libiio/blob/master/Contributors.md">libIIO Contributors</a>
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
