<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libiio: dummy-iiostream.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libiio
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Library for interfacing with IIO devices</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('dummy-iiostream_8c-example.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">dummy-iiostream.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>This example libiio program is meant to exercise the features of IIO present in the sample dummy IIO device in the linux kernel.</p>
<div class="fragment"><div class="line"><span class="comment">// SPDX-License-Identifier: GPL-2.0-or-later</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * libiio - Dummy IIO streaming example</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This example libiio program is meant to exercise the features of IIO present</span></div>
<div class="line"><span class="comment"> * in the sample dummy IIO device. For buffered access it relies on the hrtimer</span></div>
<div class="line"><span class="comment"> * trigger but could be modified to use the sysfs trigger. No hardware should</span></div>
<div class="line"><span class="comment"> * be required to run this program.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2016, DAQRI. All rights reserved.</span></div>
<div class="line"><span class="comment"> * Author: Lucas Magasweran &lt;lucas.magasweran@daqri.com&gt;</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Based on AD9361 example:</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2014 IABG mbH</span></div>
<div class="line"><span class="comment"> * Author: Michael Feilen &lt;feilen_at_iabg.de&gt;</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * How to setup the sample IIO dummy device and hrtimer trigger:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * 1. Check if `configfs` is already mounted</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * $ mount | grep &#39;config&#39;</span></div>
<div class="line"><span class="comment"> * configfs on /sys/kernel/config type configfs (rw,relatime)</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * 1.b. Mount `configfs` if it is not already mounted</span></div>
<div class="line"><span class="comment"> *  $ sudo mount -t configfs none /sys/kernel/config</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * 2. Load modules one by one</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * $ sudo modprobe industrialio</span></div>
<div class="line"><span class="comment"> * $ sudo modprobe industrialio-configfs</span></div>
<div class="line"><span class="comment"> * $ sudo modprobe industrialio-sw-device</span></div>
<div class="line"><span class="comment"> * $ sudo modprobe industrialio-sw-trigger</span></div>
<div class="line"><span class="comment"> * $ sudo modprobe iio-trig-hrtimer</span></div>
<div class="line"><span class="comment"> * $ sudo modprobe iio_dummy</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * 3. Create trigger and dummy device under `/sys/kernel/config`</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * $ sudo mkdir /sys/kernel/config/iio/triggers/hrtimer/instance1</span></div>
<div class="line"><span class="comment"> * $ sudo mkdir /sys/kernel/config/iio/devices/dummy/my_dummy_device</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * 4. Run `iio_info` to see that all worked properly</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * $ iio_info</span></div>
<div class="line"><span class="comment"> * Library version: 0.14 (git tag: c9909f2)</span></div>
<div class="line"><span class="comment"> * Compiled with backends: local xml ip</span></div>
<div class="line"><span class="comment"> * IIO context created with local backend.</span></div>
<div class="line"><span class="comment"> * Backend version: 0.14 (git tag: c9909f2)</span></div>
<div class="line"><span class="comment"> * Backend description string: Linux ...</span></div>
<div class="line"><span class="comment"> * IIO context has 1 attributes:</span></div>
<div class="line"><span class="comment"> *         local,kernel: 4.13.0-39-generic</span></div>
<div class="line"><span class="comment"> * IIO context has 2 devices:</span></div>
<div class="line"><span class="comment"> *         iio:device0: my_dummy_device</span></div>
<div class="line"><span class="comment"> *                 10 channels found:</span></div>
<div class="line"><span class="comment"> *                         activity_walking:  (input)</span></div>
<div class="line"><span class="comment"> *                         1 channel-specific attributes found:</span></div>
<div class="line"><span class="comment"> *                                 attr  0: input value: 4</span></div>
<div class="line"><span class="comment"> * ...</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> **/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iio/iio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iio/iio-debug.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define ARRAY_SIZE(arr) (sizeof(arr) / sizeof((arr)[0]))</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define IIO_ENSURE(expr) { \</span></div>
<div class="line"><span class="preprocessor">    if (!(expr)) { \</span></div>
<div class="line"><span class="preprocessor">        (void) fprintf(stderr, &quot;assertion failed (%s:%d)\n&quot;</span>, __FILE__, __LINE__); \</div>
<div class="line">        (void) abort(); \</div>
<div class="line">    } \</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> *name        = <span class="stringliteral">&quot;iio_dummy_part_no&quot;</span>;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> *trigger_str = <span class="stringliteral">&quot;instance1&quot;</span>;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> buffer_length = 1;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> count         = -1;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// libiio supports multiple methods for reading data from a buffer</span></div>
<div class="line"><span class="keyword">enum</span> {</div>
<div class="line">    BUFFER_POINTER,</div>
<div class="line">    SAMPLE_CALLBACK,</div>
<div class="line">    CHANNEL_READ_RAW,</div>
<div class="line">    CHANNEL_READ,</div>
<div class="line">    MAX_READ_METHOD,</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> buffer_read_method = BUFFER_POINTER;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Streaming devices</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_device *dev;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* IIO structs required for streaming */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_context *ctx;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_buffer  *rxbuf;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_channel **channels;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> channel_count;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_channels_mask *rxmask;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_stream *rxstream;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> stop;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> has_repeat;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* cleanup resources */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> cleanup(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (channels) { free(channels); }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Destroying stream\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (rxstream) { iio_stream_destroy(rxstream); }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Destroying buffers\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (rxbuf) { iio_buffer_destroy(rxbuf); }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Disassociate trigger\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (dev) {</div>
<div class="line">        ret = iio_device_set_trigger(dev, NULL);</div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">            <span class="keywordtype">char</span> buf[256];</div>
<div class="line">            iio_strerror(-ret, buf, <span class="keyword">sizeof</span>(buf));</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;%s while Disassociate trigger\n&quot;</span>, buf);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Destroying channel masks\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (rxmask)</div>
<div class="line">        iio_channels_mask_destroy(rxmask);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Destroying context\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (ctx) { iio_context_destroy(ctx); }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* cleanup and exit with error */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> shutdown(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    cleanup();</div>
<div class="line">    exit(1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> handle_sig(<span class="keywordtype">int</span> sig)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;Waiting for process to finish... got signal : %d\n&quot;</span>, sig);</div>
<div class="line">    stop = <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ssize_t sample_cb(<span class="keyword">const</span> <span class="keyword">struct</span> iio_channel *chn, <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> bytes, __notused <span class="keywordtype">void</span> *d)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span>iio_data_format *fmt = iio_channel_get_data_format(chn);</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j, repeat = has_repeat ? fmt-&gt;repeat : 1;</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;%s &quot;</span>, iio_channel_get_id(chn));</div>
<div class="line">    <span class="keywordflow">for</span> (j = 0; j &lt; repeat; ++j) {</div>
<div class="line">        <span class="keywordflow">if</span> (bytes == <span class="keyword">sizeof</span>(int16_t))</div>
<div class="line">            printf(<span class="stringliteral">&quot;%&quot;</span> PRIi16 <span class="stringliteral">&quot; &quot;</span>, ((int16_t *)src)[j]);</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bytes == <span class="keyword">sizeof</span>(int64_t))</div>
<div class="line">            printf(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot; &quot;</span>, ((int64_t *)src)[j]);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> bytes * repeat;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usage(__notused <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;Usage: %s [OPTION]\n&quot;</span>, argv[0]);</div>
<div class="line">    printf(<span class="stringliteral">&quot;  -d\tdevice name (default \&quot;iio_dummy_part_no\&quot;)\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;  -t\ttrigger name (default \&quot;instance1\&quot;)\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;  -b\tbuffer length (default 1)\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;  -r\tread method (default 0 pointer, 1 callback, 2 read raw, 3 read)\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;  -c\tread count (default no limit)\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> parse_options(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> c;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> ((c = getopt(argc, argv, <span class="stringliteral">&quot;d:t:b:r:c:h&quot;</span>)) != -1) {</div>
<div class="line">        <span class="keywordflow">switch</span> (c)</div>
<div class="line">        {</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:</div>
<div class="line">            name = optarg;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;t&#39;</span>:</div>
<div class="line">            trigger_str = optarg;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;b&#39;</span>:</div>
<div class="line">            buffer_length = atoi(optarg);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;r&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (atoi(optarg) &gt;= 0 &amp;&amp; atoi(optarg) &lt; MAX_READ_METHOD) {</div>
<div class="line">                buffer_read_method = atoi(optarg);</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                usage(argc, argv);</div>
<div class="line">                shutdown();</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (atoi(optarg) &gt; 0) {</div>
<div class="line">                count = atoi(optarg);</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                usage(argc, argv);</div>
<div class="line">                shutdown();</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            usage(argc, argv);</div>
<div class="line">            shutdown();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* simple configuration and streaming */</span></div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, j,</div>
<div class="line">             major = iio_context_get_version_major(NULL),</div>
<div class="line">             minor = iio_context_get_version_minor(NULL);</div>
<div class="line">    <span class="keywordtype">int</span> err;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Hardware trigger</span></div>
<div class="line">    <span class="keyword">struct </span>iio_device *trigger;</div>
<div class="line"> </div>
<div class="line">    parse_options(argc, argv);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Listen to ctrl+c and assert</span></div>
<div class="line">    signal(SIGINT, handle_sig);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;Library version: %u.%u (git tag: %s)\n&quot;</span>, major, minor,</div>
<div class="line">           iio_context_get_version_tag(NULL));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* check for struct iio_data_format.repeat support</span></div>
<div class="line"><span class="comment">     * 0.8 has repeat support, so anything greater than that */</span></div>
<div class="line">    has_repeat = ((major * 10000) + minor) &gt;= 8 ? true : <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Acquiring IIO context\n&quot;</span>);</div>
<div class="line">    ctx = iio_create_context(NULL, NULL);</div>
<div class="line">    err = iio_err(ctx);</div>
<div class="line">    IIO_ENSURE(!err &amp;&amp; <span class="stringliteral">&quot;No context&quot;</span>);</div>
<div class="line">    IIO_ENSURE(iio_context_get_devices_count(ctx) &gt; 0 &amp;&amp; <span class="stringliteral">&quot;No devices&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Acquiring device %s\n&quot;</span>, name);</div>
<div class="line">    dev = iio_context_find_device(ctx, name);</div>
<div class="line">    <span class="keywordflow">if</span> (!dev) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;No device found&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Initializing IIO streaming channels:\n&quot;</span>);</div>
<div class="line">    rxmask = iio_create_channels_mask(iio_device_get_channels_count(dev));</div>
<div class="line">    <span class="keywordflow">if</span> (!rxmask) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Unable to allocate channels mask\n&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; iio_device_get_channels_count(dev); ++i) {</div>
<div class="line">        <span class="keyword">struct </span>iio_channel *chn = iio_device_get_channel(dev, i);</div>
<div class="line">        <span class="keywordflow">if</span> (iio_channel_is_scan_element(chn)) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;%s\n&quot;</span>, iio_channel_get_id(chn));</div>
<div class="line">            channel_count++;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (channel_count == 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;No scan elements found (make sure the driver built with &#39;CONFIG_IIO_SIMPLE_DUMMY_BUFFER=y&#39;)\n&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line">    channels = calloc(channel_count, <span class="keyword">sizeof</span> *channels);</div>
<div class="line">    <span class="keywordflow">if</span> (!channels) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Channel array allocation failed&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; channel_count; ++i) {</div>
<div class="line">        <span class="keyword">struct </span>iio_channel *chn = iio_device_get_channel(dev, i);</div>
<div class="line">        <span class="keywordflow">if</span> (iio_channel_is_scan_element(chn))</div>
<div class="line">            channels[i] = chn;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Acquiring trigger %s\n&quot;</span>, trigger_str);</div>
<div class="line">    trigger = iio_context_find_device(ctx, trigger_str);</div>
<div class="line">    <span class="keywordflow">if</span> (!trigger || !iio_device_is_trigger(trigger)) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;No trigger found (try setting up the iio-trig-hrtimer module)&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Enabling IIO streaming channels for buffered capture\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; channel_count; ++i)</div>
<div class="line">        iio_channel_enable(channels[i], rxmask);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Enabling IIO buffer trigger\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (iio_device_set_trigger(dev, trigger)) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not set trigger\n&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Creating non-cyclic RX IIO buffer\n&quot;</span>);</div>
<div class="line">    rxbuf = iio_device_create_buffer(dev, NULL, rxmask);</div>
<div class="line">    err = iio_err(rxbuf);</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        rxbuf = NULL;</div>
<div class="line">        ctx_perror(ctx, err, <span class="stringliteral">&quot;Could not create buffer&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Creating IIO blocks of %u bytes\n&quot;</span>, buffer_length);</div>
<div class="line">    rxstream = iio_buffer_create_stream(rxbuf, 4, buffer_length);</div>
<div class="line">    <span class="keywordflow">if</span> (iio_err(rxstream)) {</div>
<div class="line">        rxstream = NULL;</div>
<div class="line">        ctx_perror(ctx, iio_err(rxstream), <span class="stringliteral">&quot;Could not create RX stream&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Starting IO streaming (press CTRL+C to cancel)\n&quot;</span>);</div>
<div class="line">    <span class="keywordtype">bool</span> has_ts = strcmp(iio_channel_get_id(channels[channel_count-1]), <span class="stringliteral">&quot;timestamp&quot;</span>) == 0;</div>
<div class="line">    int64_t last_ts = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (!stop)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">struct </span>iio_block *rxblock;</div>
<div class="line">        <span class="comment">/* we use a char pointer, rather than a void pointer, for p_dat &amp; p_end</span></div>
<div class="line"><span class="comment">         * to ensure the compiler understands the size is a byte, and then we</span></div>
<div class="line"><span class="comment">         * can do math on it.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <span class="keywordtype">char</span> *p_dat, *p_end;</div>
<div class="line">        ptrdiff_t p_inc;</div>
<div class="line">        int64_t now_ts;</div>
<div class="line"> </div>
<div class="line">        rxblock = iio_stream_get_next_block(rxstream);</div>
<div class="line">        err = iio_err(rxblock);</div>
<div class="line">        <span class="keywordflow">if</span> (err) {</div>
<div class="line">            ctx_perror(ctx, err, <span class="stringliteral">&quot;Unable to receive block&quot;</span>);</div>
<div class="line">            shutdown();</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        p_inc = iio_device_get_sample_size(dev, rxmask);</div>
<div class="line">        p_end = iio_block_end(rxblock);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Print timestamp delta in ms</span></div>
<div class="line">        <span class="keywordflow">if</span> (has_ts)</div>
<div class="line">            <span class="keywordflow">for</span> (p_dat = iio_block_first(rxblock, channels[channel_count-1]); p_dat &lt; p_end; p_dat += p_inc) {</div>
<div class="line">                now_ts = (((int64_t *)p_dat)[0]);</div>
<div class="line">                printf(<span class="stringliteral">&quot;[%04&quot;</span> PRId64 <span class="stringliteral">&quot;] &quot;</span>, last_ts &gt; 0 ? (now_ts - last_ts)/1000/1000 : 0);</div>
<div class="line">                last_ts = now_ts;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Print each captured sample</span></div>
<div class="line">        <span class="keywordflow">switch</span> (buffer_read_method)</div>
<div class="line">        {</div>
<div class="line">        <span class="keywordflow">case</span> BUFFER_POINTER:</div>
<div class="line">            <span class="keywordflow">for</span> (i = 0; i &lt; channel_count; ++i) {</div>
<div class="line">                <span class="keyword">const</span> <span class="keyword">struct </span>iio_data_format *fmt = iio_channel_get_data_format(channels[i]);</div>
<div class="line">                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> repeat = has_repeat ? fmt-&gt;repeat : 1;</div>
<div class="line"> </div>
<div class="line">                printf(<span class="stringliteral">&quot;%s &quot;</span>, iio_channel_get_id(channels[i]));</div>
<div class="line">                <span class="keywordflow">for</span> (p_dat = iio_block_first(rxblock, channels[i]); p_dat &lt; p_end; p_dat += p_inc) {</div>
<div class="line">                    <span class="keywordflow">for</span> (j = 0; j &lt; repeat; ++j) {</div>
<div class="line">                        <span class="keywordflow">if</span> (fmt-&gt;length/8 == <span class="keyword">sizeof</span>(int16_t))</div>
<div class="line">                            printf(<span class="stringliteral">&quot;%&quot;</span> PRIi16 <span class="stringliteral">&quot; &quot;</span>, ((int16_t *)p_dat)[j]);</div>
<div class="line">                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fmt-&gt;length/8 == <span class="keyword">sizeof</span>(int64_t))</div>
<div class="line">                            printf(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot; &quot;</span>, ((int64_t *)p_dat)[j]);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">case</span> SAMPLE_CALLBACK: {</div>
<div class="line">            ssize_t ret;</div>
<div class="line">            ret = iio_block_foreach_sample(rxblock, rxmask, sample_cb, NULL);</div>
<div class="line">            <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">                dev_perror(dev, (<span class="keywordtype">int</span>)ret, <span class="stringliteral">&quot;Unable to process buffer&quot;</span>);</div>
<div class="line">            printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">case</span> CHANNEL_READ_RAW:</div>
<div class="line">        <span class="keywordflow">case</span> CHANNEL_READ:</div>
<div class="line">            <span class="keywordflow">for</span> (i = 0; i &lt; channel_count; ++i) {</div>
<div class="line">                uint8_t *buf;</div>
<div class="line">                <span class="keywordtype">size_t</span> sample, bytes;</div>
<div class="line">                <span class="keyword">const</span> <span class="keyword">struct </span>iio_data_format *fmt = iio_channel_get_data_format(channels[i]);</div>
<div class="line">                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> repeat = has_repeat ? fmt-&gt;repeat : 1;</div>
<div class="line">                <span class="keywordtype">size_t</span> sample_size = fmt-&gt;length / 8 * repeat;</div>
<div class="line"> </div>
<div class="line">                buf = malloc(sample_size * buffer_length);</div>
<div class="line">                <span class="keywordflow">if</span> (!buf) {</div>
<div class="line">                    perror(<span class="stringliteral">&quot;trying to allocate memory for buffer\n&quot;</span>);</div>
<div class="line">                    shutdown();</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">                bytes = iio_channel_read(channels[i], rxblock, buf,</div>
<div class="line">                             sample_size * buffer_length,</div>
<div class="line">                             buffer_read_method == CHANNEL_READ_RAW);</div>
<div class="line"> </div>
<div class="line">                printf(<span class="stringliteral">&quot;%s &quot;</span>, iio_channel_get_id(channels[i]));</div>
<div class="line">                <span class="keywordflow">for</span> (sample = 0; sample &lt; bytes / sample_size; ++sample) {</div>
<div class="line">                    <span class="keywordflow">for</span> (j = 0; j &lt; repeat; ++j) {</div>
<div class="line">                        <span class="keywordflow">if</span> (fmt-&gt;length / 8 == <span class="keyword">sizeof</span>(int16_t))</div>
<div class="line">                            printf(<span class="stringliteral">&quot;%&quot;</span> PRIi16 <span class="stringliteral">&quot; &quot;</span>, ((int16_t *)buf)[sample+j]);</div>
<div class="line">                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fmt-&gt;length / 8 == <span class="keyword">sizeof</span>(int64_t))</div>
<div class="line">                            printf(<span class="stringliteral">&quot;%&quot;</span> PRId64 <span class="stringliteral">&quot; &quot;</span>, ((int64_t *)buf)[sample+j]);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">                free(buf);</div>
<div class="line">            }</div>
<div class="line">            printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (count != -1 &amp;&amp; --count == 0)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    cleanup();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
    Copyright <a href="https://github.com/analogdevicesinc/libiio/blob/master/Contributors.md">libIIO Contributors</a>
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
