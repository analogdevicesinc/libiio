<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libiio: iio-monitor.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libiio
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Library for interfacing with IIO devices</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('iio-monitor_8c-example.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">iio-monitor.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>A Curses based application which implements real time monitoring of IIO non-buffer samples.</p>
<div class="fragment"><div class="line"><span class="comment">// SPDX-License-Identifier: GPL-2.0-or-later</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * libiio - Library for interfacing industrial I/O (IIO) devices</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2014 Analog Devices, Inc.</span></div>
<div class="line"><span class="comment"> * Author: Paul Cercueil &lt;paul.cercueil@analog.com&gt;</span></div>
<div class="line"><span class="comment"> * */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef _BSD_SOURCE</span></div>
<div class="line"><span class="preprocessor">#define _BSD_SOURCE 1</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef _GNU_SOURCE</span></div>
<div class="line"><span class="preprocessor">#define _GNU_SOURCE 1</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef _DEFAULT_SOURCE</span></div>
<div class="line"><span class="preprocessor">#define _DEFAULT_SOURCE 1</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;cdk.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iio/iio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;locale.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;pthread.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef _MSC_BUILD</span></div>
<div class="line"><span class="preprocessor">#define inline __inline</span></div>
<div class="line"><span class="preprocessor">#define iio_snprintf sprintf_s</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#define iio_snprintf snprintf</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define ARRAY_SIZE(x) (sizeof(x) ? sizeof(x) / sizeof((x)[0]) : 0)</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define RED 020u</span></div>
<div class="line"><span class="preprocessor">#define YELLOW  040u</span></div>
<div class="line"><span class="preprocessor">#define BLUE    050u</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> selected = -1;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> WINDOW *win, *left, *right;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> stop;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> channel_has_attr(<span class="keyword">struct</span> iio_channel *chn, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> !!iio_channel_find_attr(chn, name);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> is_valid_channel(<span class="keyword">struct</span> iio_channel *chn)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> !iio_channel_is_output(chn) &amp;&amp;</div>
<div class="line">        (channel_has_attr(chn, <span class="stringliteral">&quot;raw&quot;</span>) ||</div>
<div class="line">         channel_has_attr(chn, <span class="stringliteral">&quot;input&quot;</span>));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> err_str(<span class="keywordtype">int</span> ret)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> buf[256];</div>
<div class="line">    iio_strerror(-ret, buf, <span class="keyword">sizeof</span>(buf));</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;Error during read: %s\n&quot;</span>, buf);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">double</span> get_channel_value(<span class="keyword">struct</span> iio_channel *chn)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span>iio_attr *attr;</div>
<div class="line">    <span class="keywordtype">char</span> *old_locale, *end;</div>
<div class="line">    <span class="keywordtype">char</span> buf[1024];</div>
<div class="line">    <span class="keywordtype">double</span> val;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"> </div>
<div class="line">    old_locale = strdup(setlocale(LC_NUMERIC, NULL));</div>
<div class="line">    setlocale(LC_NUMERIC, <span class="stringliteral">&quot;C&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    attr = iio_channel_find_attr(chn, <span class="stringliteral">&quot;input&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (attr) {</div>
<div class="line">        ret = iio_attr_read_raw(attr, buf, <span class="keyword">sizeof</span>(buf));</div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">            err_str(ret);</div>
<div class="line">            val = 0;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            errno = 0;</div>
<div class="line">            val = strtod(buf, &amp;end);</div>
<div class="line">            <span class="keywordflow">if</span> (buf == end || errno == ERANGE) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;issue decoding &#39;%s&#39; to decimal\n&quot;</span>, buf);</div>
<div class="line">                val = 0;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        attr = iio_channel_find_attr(chn, <span class="stringliteral">&quot;raw&quot;</span>);</div>
<div class="line">        ret = iio_attr_read_raw(attr, buf, <span class="keyword">sizeof</span>(buf));</div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">            err_str(ret);</div>
<div class="line">            val = 0;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            errno = 0;</div>
<div class="line">            val = strtod(buf, &amp;end);</div>
<div class="line">            <span class="keywordflow">if</span> (buf == end || errno == ERANGE) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;issue decoding &#39;%s&#39; to decimal\n&quot;</span>, buf);</div>
<div class="line">                val = 0;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        attr = iio_channel_find_attr(chn, <span class="stringliteral">&quot;offset&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (attr) {</div>
<div class="line">            ret = iio_attr_read_raw(attr, buf, <span class="keyword">sizeof</span>(buf));</div>
<div class="line">            <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">                err_str(ret);</div>
<div class="line">            <span class="keywordflow">else</span> {</div>
<div class="line">                errno = 0;</div>
<div class="line">                val += strtod(buf, &amp;end);</div>
<div class="line">                <span class="keywordflow">if</span> (buf == end || errno == ERANGE)</div>
<div class="line">                    fprintf(stderr, <span class="stringliteral">&quot;issue decoding &#39;%s&#39; to decimal\n&quot;</span>, buf);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        attr = iio_channel_find_attr(chn, <span class="stringliteral">&quot;scale&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (attr) {</div>
<div class="line">            ret = iio_attr_read_raw(attr, buf, <span class="keyword">sizeof</span>(buf));</div>
<div class="line">            <span class="keywordflow">if</span> (ret &lt; 0)</div>
<div class="line">                err_str(ret);</div>
<div class="line">            <span class="keywordflow">else</span> {</div>
<div class="line">                errno = 0;</div>
<div class="line">                val *= strtod(buf, &amp;end);</div>
<div class="line">                <span class="keywordflow">if</span> (buf == end || errno == ERANGE)</div>
<div class="line">                    fprintf(stderr, <span class="stringliteral">&quot;issue decoding &#39;%s&#39; to decimal\n&quot;</span>, buf);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    setlocale(LC_NUMERIC, old_locale);</div>
<div class="line">    free(old_locale);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> val / 1000.0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *id;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *unit;</div>
<div class="line">} map[] = {</div>
<div class="line">    { <span class="stringliteral">&quot;current&quot;</span>,    <span class="stringliteral">&quot;A&quot;</span> },</div>
<div class="line">    { <span class="stringliteral">&quot;power&quot;</span>,  <span class="stringliteral">&quot;W&quot;</span> },</div>
<div class="line">    { <span class="stringliteral">&quot;temp&quot;</span>,   <span class="stringliteral">&quot;°C&quot;</span> },</div>
<div class="line">    { <span class="stringliteral">&quot;voltage&quot;</span>,    <span class="stringliteral">&quot;V&quot;</span> },</div>
<div class="line">    { NULL, NULL },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *id_to_unit(<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; map[i].id; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (!strncmp(<span class="keywordtype">id</span>, map[i].<span class="keywordtype">id</span>, strlen(map[i].<span class="keywordtype">id</span>)))</div>
<div class="line">            <span class="keywordflow">return</span> map[i].unit;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> * read_thd(<span class="keywordtype">void</span> *d)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>iio_context *ctx = d;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (!stop) {</div>
<div class="line">        <span class="keyword">struct </span>iio_device *dev;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *name, *label;</div>
<div class="line">        <span class="keywordtype">int</span> row, col, len, align, line = 2;</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, nb_channels, nb = 0;</div>
<div class="line">        <span class="keywordtype">char</span> buf[1024];</div>
<div class="line">        chtype *str;</div>
<div class="line">        <span class="keyword">struct </span>timespec wait;</div>
<div class="line">        (void) row; <span class="comment">/* Prevent warning */</span></div>
<div class="line"> </div>
<div class="line">        wait.tv_sec = 0;</div>
<div class="line">        wait.tv_nsec = (100000 * 1000);</div>
<div class="line">        nanosleep(&amp;wait, &amp;wait);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (selected &lt; 0)</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">        dev = iio_context_get_device(ctx, selected);</div>
<div class="line"> </div>
<div class="line">        name = iio_device_get_name(dev);</div>
<div class="line">        <span class="keywordflow">if</span> (!name)</div>
<div class="line">            name = iio_device_get_id(dev);</div>
<div class="line"> </div>
<div class="line">        getmaxyx(right, row, col);</div>
<div class="line"> </div>
<div class="line">        werase(right);</div>
<div class="line"> </div>
<div class="line">        iio_snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;&lt;/B&gt;Device selected: &lt;/%u&gt;%s&lt;!%u&gt;&lt;!B&gt;&quot;</span>,</div>
<div class="line">                RED, name, RED);</div>
<div class="line">        str = char2Chtype(buf, &amp;len, &amp;align);</div>
<div class="line">        writeChtype(right, 2, line, str, HORIZONTAL, 0, len);</div>
<div class="line">        freeChtype(str);</div>
<div class="line">        line += 2;</div>
<div class="line"> </div>
<div class="line">        nb_channels = iio_device_get_channels_count(dev);</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; nb_channels; i++) {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span> *id;</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span> *unit;</div>
<div class="line">            <span class="keyword">struct </span>iio_channel *chn =</div>
<div class="line">                iio_device_get_channel(dev, i);</div>
<div class="line">            <span class="keywordflow">if</span> (!is_valid_channel(chn))</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">            nb++;</div>
<div class="line">            name = iio_channel_get_name(chn);</div>
<div class="line">            label = iio_channel_get_label(chn);</div>
<div class="line">            <span class="keywordtype">id</span> = iio_channel_get_id(chn);</div>
<div class="line">            <span class="keywordflow">if</span> (!name)</div>
<div class="line">                name = id;</div>
<div class="line">            <span class="keywordflow">if</span> (label)</div>
<div class="line">                name = label;</div>
<div class="line">            unit = id_to_unit(<span class="keywordtype">id</span>);</div>
<div class="line"> </div>
<div class="line">            iio_snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;&lt;/%u&gt;&lt;/B&gt;%s&lt;!B&gt;&lt;!%u&gt;&quot;</span>,</div>
<div class="line">                    BLUE, name, BLUE);</div>
<div class="line">            str = char2Chtype(buf, &amp;len, &amp;align);</div>
<div class="line">            writeChtype(right, 2, line, str,</div>
<div class="line">                    HORIZONTAL, 0, len);</div>
<div class="line">            freeChtype(str);</div>
<div class="line"> </div>
<div class="line">            iio_snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;&lt;/%u&gt;&lt;/B&gt;%.3lf %s&lt;!B&gt;&lt;!%u&gt;&quot;</span>,</div>
<div class="line">                    YELLOW, get_channel_value(chn), unit,</div>
<div class="line">                    YELLOW);</div>
<div class="line">            str = char2Chtype(buf, &amp;len, &amp;align);</div>
<div class="line">            writeChtype(right, col / 2, line++,</div>
<div class="line">                    str, HORIZONTAL, 0, len);</div>
<div class="line">            freeChtype(str);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (nb == 0) {</div>
<div class="line">            <span class="keywordtype">char</span> msg[] = <span class="stringliteral">&quot;No valid input channels found.&quot;</span>;</div>
<div class="line">            writeChar(right, 2, line++, msg,</div>
<div class="line">                    HORIZONTAL, 0, <span class="keyword">sizeof</span>(msg) - 1);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        boxWindow(right, 0);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>iio_context *show_contexts_screen(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>iio_context *ctx = NULL;</div>
<div class="line">    <span class="keyword">struct </span>iio_scan *scan_ctx;</div>
<div class="line">    <span class="keywordtype">size_t</span> num_contexts;</div>
<div class="line">    CDKSCREEN *screen;</div>
<div class="line">    CDKSCROLL *list;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *uri;</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keywordtype">bool</span> free_uri;</div>
<div class="line">    <span class="keywordtype">char</span> **items;</div>
<div class="line">    <span class="keywordtype">int</span> ret, err;</div>
<div class="line"> </div>
<div class="line">    screen = initCDKScreen(win);</div>
<div class="line">    <span class="keywordflow">if</span> (!screen) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;out of memory\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> scan_err;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">        scan_ctx = iio_scan(NULL, NULL);</div>
<div class="line">        err = iio_err(scan_ctx);</div>
<div class="line">        <span class="keywordflow">if</span> (err)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        num_contexts = iio_scan_get_results_count(scan_ctx);</div>
<div class="line"> </div>
<div class="line">        items = calloc(num_contexts + 1, <span class="keyword">sizeof</span>(*items));</div>
<div class="line">        <span class="keywordflow">if</span> (!items) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;calloc failed, out of memory\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; num_contexts; i++) {</div>
<div class="line">            ret = asprintf(&amp;items[i], <span class="stringliteral">&quot;&lt;/%d&gt;%s&lt;!%d&gt; &lt;/%d&gt;[%s]&lt;!%d&gt;&quot;</span>, YELLOW,</div>
<div class="line">                iio_scan_get_description(scan_ctx, i),</div>
<div class="line">                YELLOW, BLUE,</div>
<div class="line">                iio_scan_get_uri(scan_ctx, i),</div>
<div class="line">                BLUE);</div>
<div class="line">            <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;asprintf failed, out of memory?\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        items[i] = <span class="stringliteral">&quot;Enter location&quot;</span>;</div>
<div class="line"> </div>
<div class="line">        list = newCDKScroll(screen, LEFT, TOP, RIGHT, 0, 0,</div>
<div class="line">                <span class="stringliteral">&quot;\n Select a IIO context to use:\n&quot;</span>,</div>
<div class="line">                (CDK_CSTRING2) items, num_contexts + 1, TRUE,</div>
<div class="line">                A_BOLD | A_REVERSE, TRUE, FALSE);</div>
<div class="line"> </div>
<div class="line">        drawCDKScroll(list, TRUE);</div>
<div class="line"> </div>
<div class="line">        ret = activateCDKScroll(list, NULL);</div>
<div class="line">        <span class="keywordflow">if</span> (ret &lt; num_contexts) {</div>
<div class="line">            uri = iio_scan_get_uri(scan_ctx, ret);</div>
<div class="line">            free_uri = FALSE;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ret == num_contexts) {</div>
<div class="line">            uri = getString(screen,</div>
<div class="line">                    <span class="stringliteral">&quot;Please enter the location of the server&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;Location:  &quot;</span>, <span class="stringliteral">&quot;ip:localhost&quot;</span>);</div>
<div class="line">            free_uri = TRUE;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            uri = NULL;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (uri) {</div>
<div class="line">            ctx = iio_create_context(NULL, uri);</div>
<div class="line">            err = iio_err(ctx);</div>
<div class="line">            <span class="keywordflow">if</span> (err) {</div>
<div class="line">                <span class="keywordtype">char</span> *msg[] = { <span class="stringliteral">&quot;&lt;/16&gt;Failed to create IIO context.&lt;!16&gt;&quot;</span> };</div>
<div class="line">                popupLabel(screen, (CDK_CSTRING2)msg, 1);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (free_uri)</div>
<div class="line">                freeChar((<span class="keywordtype">char</span> *)uri);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        destroyCDKScroll(list);</div>
<div class="line">        iio_scan_destroy(scan_ctx);</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; num_contexts; i++)</div>
<div class="line">            free(items[i]);</div>
<div class="line">        free(items);</div>
<div class="line"> </div>
<div class="line">    } <span class="keywordflow">while</span> (err &amp;&amp; ret &gt;= 0);</div>
<div class="line"> </div>
<div class="line">    destroyCDKScreen(screen);</div>
<div class="line"> </div>
<div class="line">scan_err:</div>
<div class="line">    <span class="keywordflow">return</span> ctx;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> show_main_screen(<span class="keyword">struct</span> iio_context *ctx)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i, nb_devices;</div>
<div class="line">    CDKSCREEN *screen;</div>
<div class="line">    <span class="keywordtype">char</span> **dev_names;</div>
<div class="line">    CDKSCROLL *list;</div>
<div class="line">    pthread_t thd;</div>
<div class="line"> </div>
<div class="line">    stop = FALSE;</div>
<div class="line">    screen = initCDKScreen(left);</div>
<div class="line">    <span class="keywordflow">if</span> (!screen) {</div>
<div class="line">        stop = TRUE;</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;initCDKScreen failed, out of memory\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (pthread_create(&amp;thd, NULL, read_thd, ctx)) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;problem with pthread_create\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> thread_err;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    nb_devices = iio_context_get_devices_count(ctx);</div>
<div class="line">    dev_names = calloc(nb_devices, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *));</div>
<div class="line">    <span class="keywordflow">if</span> (!dev_names) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;calloc failed, out of memory\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> name_err;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nb_devices; i++) {</div>
<div class="line">        <span class="keywordtype">char</span> buf[1024];</div>
<div class="line">        <span class="keyword">struct </span>iio_device *dev = iio_context_get_device(ctx, i);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *name = iio_device_get_name(dev);</div>
<div class="line">        <span class="keywordflow">if</span> (!name)</div>
<div class="line">            name = iio_device_get_id(dev);</div>
<div class="line">        iio_snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;&lt;/B&gt; %s&quot;</span>, name);</div>
<div class="line">        dev_names[i] = strdup(buf);</div>
<div class="line">        <span class="keywordflow">if</span> (!dev_names[i])</div>
<div class="line">            <span class="keywordflow">goto</span> dev_name_err;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    boxWindow(right, 0);</div>
<div class="line">    list = newCDKScroll(screen, LEFT, TOP, RIGHT, 0, 0,</div>
<div class="line">            <span class="stringliteral">&quot;\n List of available IIO devices:\n&quot;</span>,</div>
<div class="line">            (CDK_CSTRING2) dev_names, nb_devices, FALSE,</div>
<div class="line">            A_BOLD | A_REVERSE, TRUE, FALSE);</div>
<div class="line"> </div>
<div class="line">    drawCDKScroll(list, TRUE);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (!stop) {</div>
<div class="line">        <span class="keywordtype">int</span> ret = activateCDKScroll(list, NULL);</div>
<div class="line">        <span class="keyword">struct </span>timespec wait;</div>
<div class="line">        wait.tv_sec = 0;</div>
<div class="line">        wait.tv_nsec = (100000 * 1000);</div>
<div class="line"> </div>
<div class="line">        stop = ret &lt; 0;</div>
<div class="line">        selected = ret;</div>
<div class="line">        nanosleep(&amp;wait, &amp;wait);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    pthread_join(thd, NULL);</div>
<div class="line"> </div>
<div class="line">    destroyCDKScroll(list);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nb_devices; i++)</div>
<div class="line">        free(dev_names[i]);</div>
<div class="line">    free(dev_names);</div>
<div class="line">    destroyCDKScreen(screen);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">dev_name_err:</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nb_devices; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (dev_names[i])</div>
<div class="line">            free(dev_names[i]);</div>
<div class="line">    }</div>
<div class="line">    free(dev_names);</div>
<div class="line">name_err:</div>
<div class="line">    stop = TRUE;</div>
<div class="line">    pthread_join(thd, NULL);</div>
<div class="line">thread_err:</div>
<div class="line">    destroyCDKScreen(screen);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>iio_context *ctx;</div>
<div class="line">    <span class="keywordtype">int</span> row, col;</div>
<div class="line"> </div>
<div class="line">    win = initscr();</div>
<div class="line">    noecho();</div>
<div class="line">    keypad(win, TRUE);</div>
<div class="line">    getmaxyx(win, row, col);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* If this was started from a small window, quit */</span></div>
<div class="line">    <span class="keywordflow">if</span> (row &lt; 10 || col &lt; 50) {</div>
<div class="line">        endwin();</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Sorry, I need a bigger window,\n&quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;min is 10 x 50\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    initCDKColor();</div>
<div class="line"> </div>
<div class="line">    left = newwin(row, col / 2, 0, 0);</div>
<div class="line">    right = newwin(row, col / 2, 0, col / 2);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (TRUE) {</div>
<div class="line">        ctx = show_contexts_screen();</div>
<div class="line">        <span class="keywordflow">if</span> (!ctx)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        show_main_screen(ctx);</div>
<div class="line">        iio_context_destroy(ctx);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    endCDK();</div>
<div class="line">    delwin(left);</div>
<div class="line">    delwin(right);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
    Copyright <a href="https://github.com/analogdevicesinc/libiio/blob/master/Contributors.md">libIIO Contributors</a>
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
