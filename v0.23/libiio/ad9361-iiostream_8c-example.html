<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libiio: ad9361-iiostream.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libiio
   &#160;<span id="projectnumber">0.23</span>
   </div>
   <div id="projectbrief">Library for interfacing with IIO devices</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ad9361-iiostream_8c-example.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">ad9361-iiostream.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>This example libiio program is meant to exercise the features of IIO functionality on the AD9361 found on the AD-FMCOMMS2-EBZ, AD-FMCOMMS3-EBZ, and the ADRV9361-Z7035 RF SOM.</p>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * libiio - AD9361 IIO streaming example</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2014 IABG mbH</span></div>
<div class="line"><span class="comment"> * Author: Michael Feilen &lt;feilen_at_iabg.de&gt;</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This program is free software; you can redistribute it and/or</span></div>
<div class="line"><span class="comment"> * modify it under the terms of the GNU General Public License</span></div>
<div class="line"><span class="comment"> * as published by the Free Software Foundation; either version 2</span></div>
<div class="line"><span class="comment"> * of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><span class="comment"> * GNU General Public License for more details.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * You should have received a copy of the GNU General Public License</span></div>
<div class="line"><span class="comment"> * along with this program; if not, write to the Free Software</span></div>
<div class="line"><span class="comment"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span></div>
<div class="line"><span class="comment"> **/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="iio_8h.html">iio.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* helper macros */</span></div>
<div class="line"><span class="preprocessor">#define MHZ(x) ((long long)(x*1000000.0 + .5))</span></div>
<div class="line"><span class="preprocessor">#define GHZ(x) ((long long)(x*1000000000.0 + .5))</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define IIO_ENSURE(expr) { \</span></div>
<div class="line"><span class="preprocessor">    if (!(expr)) { \</span></div>
<div class="line"><span class="preprocessor">        (void) fprintf(stderr, &quot;assertion failed (%s:%d)\n&quot;, __FILE__, __LINE__); \</span></div>
<div class="line"><span class="preprocessor">        (void) abort(); \</span></div>
<div class="line"><span class="preprocessor">    } \</span></div>
<div class="line"><span class="preprocessor">}</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* RX is input, TX is output */</span></div>
<div class="line"><span class="keyword">enum</span> iodev { RX, TX };</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* common RX and TX streaming params */</span></div>
<div class="line"><span class="keyword">struct </span>stream_cfg {</div>
<div class="line">    <span class="keywordtype">long</span> <span class="keywordtype">long</span> bw_hz; <span class="comment">// Analog banwidth in Hz</span></div>
<div class="line">    <span class="keywordtype">long</span> <span class="keywordtype">long</span> fs_hz; <span class="comment">// Baseband sample rate in Hz</span></div>
<div class="line">    <span class="keywordtype">long</span> <span class="keywordtype">long</span> lo_hz; <span class="comment">// Local oscillator frequency in Hz</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* rfport; <span class="comment">// Port name</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* static scratch mem for strings */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> tmpstr[64];</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* IIO structs required for streaming */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structiio__context.html">iio_context</a> *ctx   = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a1"></a><a class="code" href="structiio__channel.html">iio_channel</a> *rx0_i = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiio__channel.html">iio_channel</a> *rx0_q = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiio__channel.html">iio_channel</a> *tx0_i = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiio__channel.html">iio_channel</a> *tx0_q = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a2"></a><a class="code" href="structiio__buffer.html">iio_buffer</a>  *rxbuf = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiio__buffer.html">iio_buffer</a>  *txbuf = NULL;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> stop;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* cleanup and exit */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> shutdown()</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;* Destroying buffers\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (rxbuf) { <a name="a3"></a><a class="code" href="group__Buffer.html#gaba58dc2780be63fead6f09397ce90d10">iio_buffer_destroy</a>(rxbuf); }</div>
<div class="line">    <span class="keywordflow">if</span> (txbuf) { <a class="code" href="group__Buffer.html#gaba58dc2780be63fead6f09397ce90d10">iio_buffer_destroy</a>(txbuf); }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Disabling streaming channels\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (rx0_i) { <a name="a4"></a><a class="code" href="group__Channel.html#gad7c7c91c61b8a97187dc73cbcdb60c06">iio_channel_disable</a>(rx0_i); }</div>
<div class="line">    <span class="keywordflow">if</span> (rx0_q) { <a class="code" href="group__Channel.html#gad7c7c91c61b8a97187dc73cbcdb60c06">iio_channel_disable</a>(rx0_q); }</div>
<div class="line">    <span class="keywordflow">if</span> (tx0_i) { <a class="code" href="group__Channel.html#gad7c7c91c61b8a97187dc73cbcdb60c06">iio_channel_disable</a>(tx0_i); }</div>
<div class="line">    <span class="keywordflow">if</span> (tx0_q) { <a class="code" href="group__Channel.html#gad7c7c91c61b8a97187dc73cbcdb60c06">iio_channel_disable</a>(tx0_q); }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Destroying context\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (ctx) { <a name="a5"></a><a class="code" href="group__Context.html#ga75de8dae515c539818e52b408830d3ba">iio_context_destroy</a>(ctx); }</div>
<div class="line">    exit(0);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> handle_sig(<span class="keywordtype">int</span> sig)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;Waiting for process to finish... Got signal %d\n&quot;</span>, sig);</div>
<div class="line">    stop = <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* check return value of attr_write function */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> errchk(<span class="keywordtype">int</span> v, <span class="keyword">const</span> <span class="keywordtype">char</span>* what) {</div>
<div class="line">     <span class="keywordflow">if</span> (v &lt; 0) { fprintf(stderr, <span class="stringliteral">&quot;Error %d writing to channel \&quot;%s\&quot;\nvalue may not be supported.\n&quot;</span>, v, what); shutdown(); }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* write attribute: long long int */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> wr_ch_lli(<span class="keyword">struct</span> <a class="code" href="structiio__channel.html">iio_channel</a> *chn, <span class="keyword">const</span> <span class="keywordtype">char</span>* what, <span class="keywordtype">long</span> <span class="keywordtype">long</span> val)</div>
<div class="line">{</div>
<div class="line">    errchk(<a name="a6"></a><a class="code" href="group__Channel.html#gac55cb77a1baf797e54a8a4e31b2f4680">iio_channel_attr_write_longlong</a>(chn, what, val), what);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* write attribute: string */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> wr_ch_str(<span class="keyword">struct</span> <a class="code" href="structiio__channel.html">iio_channel</a> *chn, <span class="keyword">const</span> <span class="keywordtype">char</span>* what, <span class="keyword">const</span> <span class="keywordtype">char</span>* str)</div>
<div class="line">{</div>
<div class="line">    errchk(<a name="a7"></a><a class="code" href="group__Channel.html#ga35c76ce5fcae4c551b7c78d648665a41">iio_channel_attr_write</a>(chn, what, str), what);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* helper function generating channel names */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span>* get_ch_name(<span class="keyword">const</span> <span class="keywordtype">char</span>* type, <span class="keywordtype">int</span> <span class="keywordtype">id</span>)</div>
<div class="line">{</div>
<div class="line">    snprintf(tmpstr, <span class="keyword">sizeof</span>(tmpstr), <span class="stringliteral">&quot;%s%d&quot;</span>, type, <span class="keywordtype">id</span>);</div>
<div class="line">    <span class="keywordflow">return</span> tmpstr;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* returns ad9361 phy device */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a8"></a><a class="code" href="structiio__device.html">iio_device</a>* get_ad9361_phy(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structiio__device.html">iio_device</a> *dev =  <a name="a9"></a><a class="code" href="group__Context.html#gade1dadfb5bc3c3b236add67f803c50c3">iio_context_find_device</a>(ctx, <span class="stringliteral">&quot;ad9361-phy&quot;</span>);</div>
<div class="line">    IIO_ENSURE(dev &amp;&amp; <span class="stringliteral">&quot;No ad9361-phy found&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> dev;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* finds AD9361 streaming IIO devices */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> get_ad9361_stream_dev(<span class="keyword">enum</span> iodev d, <span class="keyword">struct</span> <a class="code" href="structiio__device.html">iio_device</a> **dev)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span> (d) {</div>
<div class="line">    <span class="keywordflow">case</span> TX: *dev = <a class="code" href="group__Context.html#gade1dadfb5bc3c3b236add67f803c50c3">iio_context_find_device</a>(ctx, <span class="stringliteral">&quot;cf-ad9361-dds-core-lpc&quot;</span>); <span class="keywordflow">return</span> *dev != NULL;</div>
<div class="line">    <span class="keywordflow">case</span> RX: *dev = <a class="code" href="group__Context.html#gade1dadfb5bc3c3b236add67f803c50c3">iio_context_find_device</a>(ctx, <span class="stringliteral">&quot;cf-ad9361-lpc&quot;</span>);  <span class="keywordflow">return</span> *dev != NULL;</div>
<div class="line">    <span class="keywordflow">default</span>: IIO_ENSURE(0); <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* finds AD9361 streaming IIO channels */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> get_ad9361_stream_ch(<span class="keyword">enum</span> iodev d, <span class="keyword">struct</span> <a class="code" href="structiio__device.html">iio_device</a> *dev, <span class="keywordtype">int</span> chid, <span class="keyword">struct</span> <a class="code" href="structiio__channel.html">iio_channel</a> **chn)</div>
<div class="line">{</div>
<div class="line">    *chn = <a name="a10"></a><a class="code" href="group__Device.html#gaffc6086189ba801ab5e95341d68f882b">iio_device_find_channel</a>(dev, get_ch_name(<span class="stringliteral">&quot;voltage&quot;</span>, chid), d == TX);</div>
<div class="line">    <span class="keywordflow">if</span> (!*chn)</div>
<div class="line">        *chn = <a class="code" href="group__Device.html#gaffc6086189ba801ab5e95341d68f882b">iio_device_find_channel</a>(dev, get_ch_name(<span class="stringliteral">&quot;altvoltage&quot;</span>, chid), d == TX);</div>
<div class="line">    <span class="keywordflow">return</span> *chn != NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* finds AD9361 phy IIO configuration channel with id chid */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> get_phy_chan(<span class="keyword">enum</span> iodev d, <span class="keywordtype">int</span> chid, <span class="keyword">struct</span> <a class="code" href="structiio__channel.html">iio_channel</a> **chn)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span> (d) {</div>
<div class="line">    <span class="keywordflow">case</span> RX: *chn = <a class="code" href="group__Device.html#gaffc6086189ba801ab5e95341d68f882b">iio_device_find_channel</a>(get_ad9361_phy(), get_ch_name(<span class="stringliteral">&quot;voltage&quot;</span>, chid), <span class="keyword">false</span>); <span class="keywordflow">return</span> *chn != NULL;</div>
<div class="line">    <span class="keywordflow">case</span> TX: *chn = <a class="code" href="group__Device.html#gaffc6086189ba801ab5e95341d68f882b">iio_device_find_channel</a>(get_ad9361_phy(), get_ch_name(<span class="stringliteral">&quot;voltage&quot;</span>, chid), <span class="keyword">true</span>);  <span class="keywordflow">return</span> *chn != NULL;</div>
<div class="line">    <span class="keywordflow">default</span>: IIO_ENSURE(0); <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* finds AD9361 local oscillator IIO configuration channels */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> get_lo_chan(<span class="keyword">enum</span> iodev d, <span class="keyword">struct</span> <a class="code" href="structiio__channel.html">iio_channel</a> **chn)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span> (d) {</div>
<div class="line">     <span class="comment">// LO chan is always output, i.e. true</span></div>
<div class="line">    <span class="keywordflow">case</span> RX: *chn = <a class="code" href="group__Device.html#gaffc6086189ba801ab5e95341d68f882b">iio_device_find_channel</a>(get_ad9361_phy(), get_ch_name(<span class="stringliteral">&quot;altvoltage&quot;</span>, 0), <span class="keyword">true</span>); <span class="keywordflow">return</span> *chn != NULL;</div>
<div class="line">    <span class="keywordflow">case</span> TX: *chn = <a class="code" href="group__Device.html#gaffc6086189ba801ab5e95341d68f882b">iio_device_find_channel</a>(get_ad9361_phy(), get_ch_name(<span class="stringliteral">&quot;altvoltage&quot;</span>, 1), <span class="keyword">true</span>); <span class="keywordflow">return</span> *chn != NULL;</div>
<div class="line">    <span class="keywordflow">default</span>: IIO_ENSURE(0); <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* applies streaming configuration through IIO */</span></div>
<div class="line"><span class="keywordtype">bool</span> cfg_ad9361_streaming_ch(<span class="keyword">struct</span> stream_cfg *cfg, <span class="keyword">enum</span> iodev type, <span class="keywordtype">int</span> chid)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structiio__channel.html">iio_channel</a> *chn = NULL;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Configure phy and lo channels</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;* Acquiring AD9361 phy channel %d\n&quot;</span>, chid);</div>
<div class="line">    <span class="keywordflow">if</span> (!get_phy_chan(type, chid, &amp;chn)) {  <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">    wr_ch_str(chn, <span class="stringliteral">&quot;rf_port_select&quot;</span>,     cfg-&gt;rfport);</div>
<div class="line">    wr_ch_lli(chn, <span class="stringliteral">&quot;rf_bandwidth&quot;</span>,       cfg-&gt;bw_hz);</div>
<div class="line">    wr_ch_lli(chn, <span class="stringliteral">&quot;sampling_frequency&quot;</span>, cfg-&gt;fs_hz);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Configure LO channel</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;* Acquiring AD9361 %s lo channel\n&quot;</span>, type == TX ? <span class="stringliteral">&quot;TX&quot;</span> : <span class="stringliteral">&quot;RX&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (!get_lo_chan(type, &amp;chn)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">    wr_ch_lli(chn, <span class="stringliteral">&quot;frequency&quot;</span>, cfg-&gt;lo_hz);</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* simple configuration and streaming */</span></div>
<div class="line"><span class="comment">/* usage:</span></div>
<div class="line"><span class="comment"> * Default context, assuming local IIO devices, i.e., this script is run on ADALM-Pluto for example</span></div>
<div class="line"><span class="comment"> $./a.out</span></div>
<div class="line"><span class="comment"> * URI context, find out the uri by typing `iio_info -s` at the command line of the host PC</span></div>
<div class="line"><span class="comment"> $./a.out usb:x.x.x</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Streaming devices</span></div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structiio__device.html">iio_device</a> *tx;</div>
<div class="line">    <span class="keyword">struct </span><a class="code" href="structiio__device.html">iio_device</a> *rx;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// RX and TX sample counters</span></div>
<div class="line">    <span class="keywordtype">size_t</span> nrx = 0;</div>
<div class="line">    <span class="keywordtype">size_t</span> ntx = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Stream configurations</span></div>
<div class="line">    <span class="keyword">struct </span>stream_cfg rxcfg;</div>
<div class="line">    <span class="keyword">struct </span>stream_cfg txcfg;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Listen to ctrl+c and IIO_ENSURE</span></div>
<div class="line">    signal(SIGINT, handle_sig);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// RX stream config</span></div>
<div class="line">    rxcfg.bw_hz = MHZ(2);   <span class="comment">// 2 MHz rf bandwidth</span></div>
<div class="line">    rxcfg.fs_hz = MHZ(2.5);   <span class="comment">// 2.5 MS/s rx sample rate</span></div>
<div class="line">    rxcfg.lo_hz = GHZ(2.5); <span class="comment">// 2.5 GHz rf frequency</span></div>
<div class="line">    rxcfg.rfport = <span class="stringliteral">&quot;A_BALANCED&quot;</span>; <span class="comment">// port A (select for rf freq.)</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// TX stream config</span></div>
<div class="line">    txcfg.bw_hz = MHZ(1.5); <span class="comment">// 1.5 MHz rf bandwidth</span></div>
<div class="line">    txcfg.fs_hz = MHZ(2.5);   <span class="comment">// 2.5 MS/s tx sample rate</span></div>
<div class="line">    txcfg.lo_hz = GHZ(2.5); <span class="comment">// 2.5 GHz rf frequency</span></div>
<div class="line">    txcfg.rfport = <span class="stringliteral">&quot;A&quot;</span>; <span class="comment">// port A (select for rf freq.)</span></div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Acquiring IIO context\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (argc == 1) {</div>
<div class="line">        IIO_ENSURE((ctx = <a name="a11"></a><a class="code" href="group__Context.html#ga21076125f817a680e0c01d4a490f0416">iio_create_default_context</a>()) &amp;&amp; <span class="stringliteral">&quot;No context&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argc == 2) {</div>
<div class="line">        IIO_ENSURE((ctx = <a name="a12"></a><a class="code" href="group__Context.html#gafdcee40508700fa395370b6c636e16fe">iio_create_context_from_uri</a>(argv[1])) &amp;&amp; <span class="stringliteral">&quot;No context&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    IIO_ENSURE(<a name="a13"></a><a class="code" href="group__Context.html#gab4fc2a93fd5824f3c9e06aa81e8097d1">iio_context_get_devices_count</a>(ctx) &gt; 0 &amp;&amp; <span class="stringliteral">&quot;No devices&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Acquiring AD9361 streaming devices\n&quot;</span>);</div>
<div class="line">    IIO_ENSURE(get_ad9361_stream_dev(TX, &amp;tx) &amp;&amp; <span class="stringliteral">&quot;No tx dev found&quot;</span>);</div>
<div class="line">    IIO_ENSURE(get_ad9361_stream_dev(RX, &amp;rx) &amp;&amp; <span class="stringliteral">&quot;No rx dev found&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Configuring AD9361 for streaming\n&quot;</span>);</div>
<div class="line">    IIO_ENSURE(cfg_ad9361_streaming_ch(&amp;rxcfg, RX, 0) &amp;&amp; <span class="stringliteral">&quot;RX port 0 not found&quot;</span>);</div>
<div class="line">    IIO_ENSURE(cfg_ad9361_streaming_ch(&amp;txcfg, TX, 0) &amp;&amp; <span class="stringliteral">&quot;TX port 0 not found&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Initializing AD9361 IIO streaming channels\n&quot;</span>);</div>
<div class="line">    IIO_ENSURE(get_ad9361_stream_ch(RX, rx, 0, &amp;rx0_i) &amp;&amp; <span class="stringliteral">&quot;RX chan i not found&quot;</span>);</div>
<div class="line">    IIO_ENSURE(get_ad9361_stream_ch(RX, rx, 1, &amp;rx0_q) &amp;&amp; <span class="stringliteral">&quot;RX chan q not found&quot;</span>);</div>
<div class="line">    IIO_ENSURE(get_ad9361_stream_ch(TX, tx, 0, &amp;tx0_i) &amp;&amp; <span class="stringliteral">&quot;TX chan i not found&quot;</span>);</div>
<div class="line">    IIO_ENSURE(get_ad9361_stream_ch(TX, tx, 1, &amp;tx0_q) &amp;&amp; <span class="stringliteral">&quot;TX chan q not found&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Enabling IIO streaming channels\n&quot;</span>);</div>
<div class="line">    <a name="a14"></a><a class="code" href="group__Channel.html#ga2b787983683d37966b5e1e5c6c121d6a">iio_channel_enable</a>(rx0_i);</div>
<div class="line">    <a class="code" href="group__Channel.html#ga2b787983683d37966b5e1e5c6c121d6a">iio_channel_enable</a>(rx0_q);</div>
<div class="line">    <a class="code" href="group__Channel.html#ga2b787983683d37966b5e1e5c6c121d6a">iio_channel_enable</a>(tx0_i);</div>
<div class="line">    <a class="code" href="group__Channel.html#ga2b787983683d37966b5e1e5c6c121d6a">iio_channel_enable</a>(tx0_q);</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Creating non-cyclic IIO buffers with 1 MiS\n&quot;</span>);</div>
<div class="line">    rxbuf = <a name="a15"></a><a class="code" href="group__Buffer.html#gaea8067aca27b93a1260a0c563607a501">iio_device_create_buffer</a>(rx, 1024*1024, <span class="keyword">false</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (!rxbuf) {</div>
<div class="line">        perror(<span class="stringliteral">&quot;Could not create RX buffer&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line">    txbuf = <a class="code" href="group__Buffer.html#gaea8067aca27b93a1260a0c563607a501">iio_device_create_buffer</a>(tx, 1024*1024, <span class="keyword">false</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (!txbuf) {</div>
<div class="line">        perror(<span class="stringliteral">&quot;Could not create TX buffer&quot;</span>);</div>
<div class="line">        shutdown();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    printf(<span class="stringliteral">&quot;* Starting IO streaming (press CTRL+C to cancel)\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">while</span> (!stop)</div>
<div class="line">    {</div>
<div class="line">        ssize_t nbytes_rx, nbytes_tx;</div>
<div class="line">        <span class="keywordtype">char</span> *p_dat, *p_end;</div>
<div class="line">        ptrdiff_t p_inc;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Schedule TX buffer</span></div>
<div class="line">        nbytes_tx = <a name="a16"></a><a class="code" href="group__Buffer.html#gae7033c625d128667a56cf482aa3149bd">iio_buffer_push</a>(txbuf);</div>
<div class="line">        <span class="keywordflow">if</span> (nbytes_tx &lt; 0) { printf(<span class="stringliteral">&quot;Error pushing buf %d\n&quot;</span>, (<span class="keywordtype">int</span>) nbytes_tx); shutdown(); }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Refill RX buffer</span></div>
<div class="line">        nbytes_rx = <a name="a17"></a><a class="code" href="group__Buffer.html#gac999e5244b5a2cbbca5ecaef8303a4ff">iio_buffer_refill</a>(rxbuf);</div>
<div class="line">        <span class="keywordflow">if</span> (nbytes_rx &lt; 0) { printf(<span class="stringliteral">&quot;Error refilling buf %d\n&quot;</span>,(<span class="keywordtype">int</span>) nbytes_rx); shutdown(); }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// READ: Get pointers to RX buf and read IQ from RX buf port 0</span></div>
<div class="line">        p_inc = <a name="a18"></a><a class="code" href="group__Buffer.html#ga5532665a8776cec1c209d6cf8d0bb409">iio_buffer_step</a>(rxbuf);</div>
<div class="line">        p_end = <a name="a19"></a><a class="code" href="group__Buffer.html#gab5300f917bbdfc5dafc093a60138f131">iio_buffer_end</a>(rxbuf);</div>
<div class="line">        <span class="keywordflow">for</span> (p_dat = (<span class="keywordtype">char</span> *)<a name="a20"></a><a class="code" href="group__Buffer.html#ga000d2f4c8b72060db1c38ec905bf4156">iio_buffer_first</a>(rxbuf, rx0_i); p_dat &lt; p_end; p_dat += p_inc) {</div>
<div class="line">            <span class="comment">// Example: swap I and Q</span></div>
<div class="line">            <span class="keyword">const</span> int16_t i = ((int16_t*)p_dat)[0]; <span class="comment">// Real (I)</span></div>
<div class="line">            <span class="keyword">const</span> int16_t q = ((int16_t*)p_dat)[1]; <span class="comment">// Imag (Q)</span></div>
<div class="line">            ((int16_t*)p_dat)[0] = q;</div>
<div class="line">            ((int16_t*)p_dat)[1] = i;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// WRITE: Get pointers to TX buf and write IQ to TX buf port 0</span></div>
<div class="line">        p_inc = <a class="code" href="group__Buffer.html#ga5532665a8776cec1c209d6cf8d0bb409">iio_buffer_step</a>(txbuf);</div>
<div class="line">        p_end = <a class="code" href="group__Buffer.html#gab5300f917bbdfc5dafc093a60138f131">iio_buffer_end</a>(txbuf);</div>
<div class="line">        <span class="keywordflow">for</span> (p_dat = (<span class="keywordtype">char</span> *)<a class="code" href="group__Buffer.html#ga000d2f4c8b72060db1c38ec905bf4156">iio_buffer_first</a>(txbuf, tx0_i); p_dat &lt; p_end; p_dat += p_inc) {</div>
<div class="line">            <span class="comment">// Example: fill with zeros</span></div>
<div class="line">            <span class="comment">// 12-bit sample needs to be MSB aligned so shift by 4</span></div>
<div class="line">            <span class="comment">// https://wiki.analog.com/resources/eval/user-guides/ad-fmcomms2-ebz/software/basic_iq_datafiles#binary_format</span></div>
<div class="line">            ((int16_t*)p_dat)[0] = 0 &lt;&lt; 4; <span class="comment">// Real (I)</span></div>
<div class="line">            ((int16_t*)p_dat)[1] = 0 &lt;&lt; 4; <span class="comment">// Imag (Q)</span></div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Sample counter increment and status output</span></div>
<div class="line">        nrx += nbytes_rx / <a name="a21"></a><a class="code" href="group__Debug.html#ga52b3e955c10d6f962b2c2e749c7c02fb">iio_device_get_sample_size</a>(rx);</div>
<div class="line">        ntx += nbytes_tx / <a class="code" href="group__Debug.html#ga52b3e955c10d6f962b2c2e749c7c02fb">iio_device_get_sample_size</a>(tx);</div>
<div class="line">        printf(<span class="stringliteral">&quot;\tRX %8.2f MSmp, TX %8.2f MSmp\n&quot;</span>, nrx/1e6, ntx/1e6);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    shutdown();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="agroup__Buffer_html_gab5300f917bbdfc5dafc093a60138f131"><div class="ttname"><a href="group__Buffer.html#gab5300f917bbdfc5dafc093a60138f131">iio_buffer_end</a></div><div class="ttdeci">void * iio_buffer_end(const struct iio_buffer *buffer)</div><div class="ttdoc">Get the address that follows the last sample in a buffer.</div><div class="ttdef"><b>Definition:</b> buffer.c:293</div></div>
<div class="ttc" id="astructiio__channel_html"><div class="ttname"><a href="structiio__channel.html">iio_channel</a></div><div class="ttdoc">Represents an input or output channel of a device.</div></div>
<div class="ttc" id="agroup__Buffer_html_gae7033c625d128667a56cf482aa3149bd"><div class="ttname"><a href="group__Buffer.html#gae7033c625d128667a56cf482aa3149bd">iio_buffer_push</a></div><div class="ttdeci">ssize_t iio_buffer_push(struct iio_buffer *buffer)</div><div class="ttdoc">Send the samples to the hardware.</div><div class="ttdef"><b>Definition:</b> buffer.c:147</div></div>
<div class="ttc" id="agroup__Device_html_gaffc6086189ba801ab5e95341d68f882b"><div class="ttname"><a href="group__Device.html#gaffc6086189ba801ab5e95341d68f882b">iio_device_find_channel</a></div><div class="ttdeci">struct iio_channel * iio_device_find_channel(const struct iio_device *dev, const char *name, bool output)</div><div class="ttdoc">Try to find a channel structure by its name of ID.</div><div class="ttdef"><b>Definition:</b> device.c:157</div></div>
<div class="ttc" id="agroup__Channel_html_gac55cb77a1baf797e54a8a4e31b2f4680"><div class="ttname"><a href="group__Channel.html#gac55cb77a1baf797e54a8a4e31b2f4680">iio_channel_attr_write_longlong</a></div><div class="ttdeci">int iio_channel_attr_write_longlong(const struct iio_channel *chn, const char *attr, long long val)</div><div class="ttdoc">Set the value of the given channel-specific attribute.</div><div class="ttdef"><b>Definition:</b> channel.c:644</div></div>
<div class="ttc" id="agroup__Channel_html_ga35c76ce5fcae4c551b7c78d648665a41"><div class="ttname"><a href="group__Channel.html#ga35c76ce5fcae4c551b7c78d648665a41">iio_channel_attr_write</a></div><div class="ttdeci">ssize_t iio_channel_attr_write(const struct iio_channel *chn, const char *attr, const char *src)</div><div class="ttdoc">Set the value of the given channel-specific attribute.</div><div class="ttdef"><b>Definition:</b> channel.c:334</div></div>
<div class="ttc" id="agroup__Channel_html_ga2b787983683d37966b5e1e5c6c121d6a"><div class="ttname"><a href="group__Channel.html#ga2b787983683d37966b5e1e5c6c121d6a">iio_channel_enable</a></div><div class="ttdeci">void iio_channel_enable(struct iio_channel *chn)</div><div class="ttdoc">Enable the given channel.</div><div class="ttdef"><b>Definition:</b> channel.c:367</div></div>
<div class="ttc" id="agroup__Channel_html_gad7c7c91c61b8a97187dc73cbcdb60c06"><div class="ttname"><a href="group__Channel.html#gad7c7c91c61b8a97187dc73cbcdb60c06">iio_channel_disable</a></div><div class="ttdeci">void iio_channel_disable(struct iio_channel *chn)</div><div class="ttdoc">Disable the given channel.</div><div class="ttdef"><b>Definition:</b> channel.c:373</div></div>
<div class="ttc" id="agroup__Buffer_html_ga5532665a8776cec1c209d6cf8d0bb409"><div class="ttname"><a href="group__Buffer.html#ga5532665a8776cec1c209d6cf8d0bb409">iio_buffer_step</a></div><div class="ttdeci">ptrdiff_t iio_buffer_step(const struct iio_buffer *buffer)</div><div class="ttdoc">Get the step size between two samples of one channel.</div><div class="ttdef"><b>Definition:</b> buffer.c:288</div></div>
<div class="ttc" id="aiio_8h_html"><div class="ttname"><a href="iio_8h.html">iio.h</a></div><div class="ttdoc">Public interface.</div></div>
<div class="ttc" id="agroup__Buffer_html_gac999e5244b5a2cbbca5ecaef8303a4ff"><div class="ttname"><a href="group__Buffer.html#gac999e5244b5a2cbbca5ecaef8303a4ff">iio_buffer_refill</a></div><div class="ttdeci">ssize_t iio_buffer_refill(struct iio_buffer *buffer)</div><div class="ttdoc">Fetch more samples from the hardware.</div><div class="ttdef"><b>Definition:</b> buffer.c:123</div></div>
<div class="ttc" id="agroup__Context_html_gab4fc2a93fd5824f3c9e06aa81e8097d1"><div class="ttname"><a href="group__Context.html#gab4fc2a93fd5824f3c9e06aa81e8097d1">iio_context_get_devices_count</a></div><div class="ttdeci">unsigned int iio_context_get_devices_count(const struct iio_context *ctx)</div><div class="ttdoc">Enumerate the devices found in the given context.</div><div class="ttdef"><b>Definition:</b> context.c:280</div></div>
<div class="ttc" id="astructiio__buffer_html"><div class="ttname"><a href="structiio__buffer.html">iio_buffer</a></div><div class="ttdoc">An input or output buffer, used to read or write samples.</div></div>
<div class="ttc" id="agroup__Context_html_ga75de8dae515c539818e52b408830d3ba"><div class="ttname"><a href="group__Context.html#ga75de8dae515c539818e52b408830d3ba">iio_context_destroy</a></div><div class="ttdeci">void iio_context_destroy(struct iio_context *ctx)</div><div class="ttdoc">Destroy the given context.</div><div class="ttdef"><b>Definition:</b> context.c:258</div></div>
<div class="ttc" id="agroup__Buffer_html_gaba58dc2780be63fead6f09397ce90d10"><div class="ttname"><a href="group__Buffer.html#gaba58dc2780be63fead6f09397ce90d10">iio_buffer_destroy</a></div><div class="ttdeci">void iio_buffer_destroy(struct iio_buffer *buffer)</div><div class="ttdoc">Destroy the given buffer.</div><div class="ttdef"><b>Definition:</b> buffer.c:104</div></div>
<div class="ttc" id="agroup__Debug_html_ga52b3e955c10d6f962b2c2e749c7c02fb"><div class="ttname"><a href="group__Debug.html#ga52b3e955c10d6f962b2c2e749c7c02fb">iio_device_get_sample_size</a></div><div class="ttdeci">ssize_t iio_device_get_sample_size(const struct iio_device *dev)</div><div class="ttdoc">Get the current sample size.</div><div class="ttdef"><b>Definition:</b> device.c:476</div></div>
<div class="ttc" id="astructiio__context_html"><div class="ttname"><a href="structiio__context.html">iio_context</a></div><div class="ttdoc">Contains the representation of an IIO context.</div></div>
<div class="ttc" id="agroup__Buffer_html_ga000d2f4c8b72060db1c38ec905bf4156"><div class="ttname"><a href="group__Buffer.html#ga000d2f4c8b72060db1c38ec905bf4156">iio_buffer_first</a></div><div class="ttdeci">void * iio_buffer_first(const struct iio_buffer *buffer, const struct iio_channel *chn)</div><div class="ttdoc">Find the first sample of a channel in a buffer.</div><div class="ttdef"><b>Definition:</b> buffer.c:250</div></div>
<div class="ttc" id="astructiio__device_html"><div class="ttname"><a href="structiio__device.html">iio_device</a></div><div class="ttdoc">Represents a device in the IIO context.</div></div>
<div class="ttc" id="agroup__Context_html_gafdcee40508700fa395370b6c636e16fe"><div class="ttname"><a href="group__Context.html#gafdcee40508700fa395370b6c636e16fe">iio_create_context_from_uri</a></div><div class="ttdeci">struct iio_context * iio_create_context_from_uri(const char *uri)</div><div class="ttdoc">Create a context from a URI description.</div><div class="ttdef"><b>Definition:</b> context.c:394</div></div>
<div class="ttc" id="agroup__Context_html_gade1dadfb5bc3c3b236add67f803c50c3"><div class="ttname"><a href="group__Context.html#gade1dadfb5bc3c3b236add67f803c50c3">iio_context_find_device</a></div><div class="ttdeci">struct iio_device * iio_context_find_device(const struct iio_context *ctx, const char *name)</div><div class="ttdoc">Try to find a device structure by its ID, label or name.</div><div class="ttdef"><b>Definition:</b> context.c:294</div></div>
<div class="ttc" id="agroup__Buffer_html_gaea8067aca27b93a1260a0c563607a501"><div class="ttname"><a href="group__Buffer.html#gaea8067aca27b93a1260a0c563607a501">iio_device_create_buffer</a></div><div class="ttdeci">struct iio_buffer * iio_device_create_buffer(const struct iio_device *dev, size_t samples_count, bool cyclic)</div><div class="ttdoc">Create an input or output buffer associated to the given device.</div><div class="ttdef"><b>Definition:</b> buffer.c:26</div></div>
<div class="ttc" id="agroup__Context_html_ga21076125f817a680e0c01d4a490f0416"><div class="ttname"><a href="group__Context.html#ga21076125f817a680e0c01d4a490f0416">iio_create_default_context</a></div><div class="ttdeci">struct iio_context * iio_create_default_context(void)</div><div class="ttdoc">Create a context from local or remote IIO devices.</div><div class="ttdef"><b>Definition:</b> context.c:415</div></div>
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
    Copyright <a href="https://github.com/analogdevicesinc/libiio/blob/master/Contributors.md">libIIO Contributors</a>
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
