#!/bin/sh -e

. CI/travis/lib.sh

install_sphinx() {
	if command_exists $PYTHON ; then
		$PYTHON --version
		command -v $PYTHON
		$PYTHON -m pip install sphinx
		$PYTHON -m pip install sphinx-rtd-theme
	fi
}

handle_centos() {
	# needed for man2html and a few other popular tools
	yum search epel-release
	yum info epel-release
	yum -y install epel-release

	# FIXME: see about adding `libserialport-dev` from EPEL ; maybe libusb-1.0.0-devel...
	yum -y groupinstall 'Development Tools'
	yum -y install cmake libxml2-devel libusb1-devel libaio-devel \
		bzip2 gzip rpm rpm-build

	# needed for building python with pyenv
	yum install -y  gcc gcc-c++ make git patch openssl-devel zlib-devel readline-devel sqlite-devel bzip2-devel

	# CentOS 6 & 7 don't work with doc, or the latest python.
	# install_pyenv
	# install_python

	if [ "$(get_version | head -c 1)" = "7" ] ; then
		# install Cmake3, and make it the default
		yum -y install cmake3
		alternatives --install /usr/local/bin/cmake cmake /usr/bin/cmake 10 \
			--slave /usr/local/bin/ctest ctest /usr/bin/ctest \
			--slave /usr/local/bin/cpack cpack /usr/bin/cpack \
			--slave /usr/local/bin/ccmake ccmake /usr/bin/ccmake \
			--family cmake
		alternatives --install /usr/local/bin/cmake cmake /usr/bin/cmake3 20 \
			--slave /usr/local/bin/ctest ctest /usr/bin/ctest3 \
			--slave /usr/local/bin/cpack cpack /usr/bin/cpack3 \
			--slave /usr/local/bin/ccmake ccmake /usr/bin/ccmake3 \
			--family cmake
	fi

	if is_centos_at_least_ver "8" ; then
		# On CentOS 8, avahi-devel & doxygen are in this repo; enable it
		yum -y install yum-utils
		yum config-manager --set-enabled powertools
		# On CentOS 6 & 7, have issues building or packaging doc
		yum -y install python3 doxygen man2html
		install_sphinx
	else
		# On CentOS 8, cdk-devel (Curses Development Kit) does not exist yet
		yum -y install ncurses-devel cdk-devel
	fi

	yum -y install avahi-devel
}

handle_generic_docker() {
	prepare_docker_image
}

handle_default() {
	sudo apt-get -qq update
	sudo apt-get install -y apt-utils
	sudo DEBIAN_FRONTEND=noninteractive apt-get install -y cmake graphviz \
		libaio-dev libavahi-client-dev libserialport-dev \
		libavahi-common-dev libusb-1.0-0-dev libxml2-dev rpm tar \
		bzip2 gzip flex bison git libncurses5-dev libcdk5-dev

	# Most of these should be here, but are needed for building python by pyenv
	sudo DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential \
		libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev \
		wget curl llvm libncurses5-dev libncursesw5-dev xz-utils tk-dev \
		libffi-dev liblzma-dev python3-openssl git \
		doxygen man2html python3 python3-pip

	if is_python_at_least_ver "$PYTHON" "3.6" ; then
		install_sphinx
	fi
}

handle_debian() {
	handle_default
}

setup_build_type_env_vars

handle_${BUILD_TYPE}
