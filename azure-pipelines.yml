# TEST PIPELINE - Verify compile-time vs runtime variable evaluation
# Testing if ${{ }} template expressions can access Build.SourceBranch

variables:
  # COMPILE-TIME: ${{ }} - evaluated BEFORE pipeline runs
  ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/test-cmakeBuildType') }}:
    isTestBranch_compiletime: 'TRUE'
  ${{ else }}:
    isTestBranch_compiletime: 'FALSE'

  # cmakeBuildType using COMPILE-TIME expression (current approach)
  ${{ if startsWith(variables['Build.SourceBranch'], 'refs/tags/v') }}:
    cmakeBuildType_compiletime: 'Release'
  ${{ else }}:
    cmakeBuildType_compiletime: 'RelWithDebInfo'

  # RUNTIME: $[ ] - evaluated WHEN pipeline runs
  isTestBranch_runtime: $[eq(variables['Build.SourceBranch'], 'refs/heads/test-cmakeBuildType')]
  # cmakeBuildType using RUNTIME expression (alternative approach)
  cmakeBuildType_runtime: $[if(startsWith(variables['Build.SourceBranch'], 'refs/tags/v'), 'Release', 'RelWithDebInfo')]

trigger:
  branches:
    include:
    - test-cmakeBuildType

pr: none

stages:
- stage: TestVariables
  jobs:
  - job: CheckVariables
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        echo "======================================"
        echo "COMPILE-TIME vs RUNTIME TEST"
        echo "======================================"
        echo ""
        echo "Build.SourceBranch (actual): $(Build.SourceBranch)"
        echo ""
        echo "--- isTestBranch ---"
        echo "isTestBranch_compiletime: $(isTestBranch_compiletime)"
        echo "isTestBranch_runtime:     $(isTestBranch_runtime)"
        echo ""
        echo "--- cmakeBuildType ---"
        echo "cmakeBuildType_compiletime: $(cmakeBuildType_compiletime)"
        echo "cmakeBuildType_runtime:     $(cmakeBuildType_runtime)"
        echo ""
        echo "======================================"
        echo "EXPECTED for test-cmakeBuildType branch:"
        echo "  isTestBranch: TRUE (both)"
        echo "  cmakeBuildType: RelWithDebInfo (both)"
        echo ""
        echo "If compile-time differs from runtime,"
        echo "then Build.SourceBranch is NOT available at compile time!"
        echo "======================================"
      displayName: 'Compare compile-time vs runtime'
