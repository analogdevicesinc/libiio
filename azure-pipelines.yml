# TEST PIPELINE - Verify compile-time vs runtime variable evaluation
# Testing if ${{ }} template expressions can access Build.SourceBranch

variables:
  # COMPILE-TIME: These use ${{ }} - evaluated BEFORE pipeline runs
  # The question: Is Build.SourceBranch available at compile time?
  ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/main') }}:
    isMain_compiletime: 'TRUE_compiletime'
  ${{ else }}:
    isMain_compiletime: 'FALSE_compiletime'

  ${{ if startsWith(variables['Build.SourceBranch'], 'refs/tags/v') }}:
    isRelease_compiletime: 'TRUE_compiletime'
    cmakeBuildType: 'Release'
  ${{ else }}:
    isRelease_compiletime: 'FALSE_compiletime'
    cmakeBuildType: 'RelWithDebInfo'

  # RUNTIME: These use $[ ] - evaluated WHEN pipeline runs
  isMain_runtime: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  isRelease_runtime: $[startsWith(variables['Build.SourceBranch'], 'refs/tags/v')]

trigger:
  branches:
    include:
    - test-cmakeBuildType

pr: none

stages:
- stage: TestVariables
  jobs:
  - job: CheckVariables
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        echo "======================================"
        echo "COMPILE-TIME vs RUNTIME TEST"
        echo "======================================"
        echo ""
        echo "Build.SourceBranch (actual): $(Build.SourceBranch)"
        echo ""
        echo "--- COMPILE-TIME (\${{ }}) results ---"
        echo "isMain_compiletime:    $(isMain_compiletime)"
        echo "isRelease_compiletime: $(isRelease_compiletime)"
        echo "cmakeBuildType:        $(cmakeBuildType)"
        echo ""
        echo "--- RUNTIME (\$[ ]) results ---"
        echo "isMain_runtime:    $(isMain_runtime)"
        echo "isRelease_runtime: $(isRelease_runtime)"
        echo ""
        echo "======================================"
        echo "ANALYSIS:"
        echo "If compile-time shows FALSE but runtime shows true/false correctly,"
        echo "then Build.SourceBranch is NOT available at compile time!"
        echo "======================================"
      displayName: 'Compare compile-time vs runtime'
